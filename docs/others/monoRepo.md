# MonoRepo

monoRepo å…¶å®å°±æ˜¯å°†å¤šä¸ªé¡¹ç›®æ•´åˆåˆ°ä¸€ä¸ª git é¡¹ç›®ä¸­è¿›è¡Œç®¡ç†çš„ä¸€ç§æ–¹å¼ã€‚åº”è¯¥å¤§å®¶éƒ½æœ‰ç”¨è¿‡æˆ–è€…è§è¿‡è¿™ç§ä»£ç ç®¡ç†æ–¹å¼ï¼Œå¯èƒ½ä¸æ¸…æ¥šè¿™ä¸ªåè¯è€Œå·²ã€‚å¾ˆå¤šçŸ¥åå¼€æºé¡¹ç›®éƒ½é‡‡ç”¨äº†è¿™ç§æ–¹å¼ï¼Œæ¯”å¦‚ babelã€vue3 ç­‰ç­‰ã€‚

![babel](../images/babel.png)

ä¸ monoRepo ç›¸å¯¹åº”çš„å°±æ˜¯å°†å¤šä¸ªé¡¹ç›®åˆ†å¼€åœ¨ä¸åŒçš„ä»£ç ä»“åº“ä¸­è¿›è¡Œç®¡ç†ï¼Œå³ multiRepoã€‚ä¸¤è€…çš„å…³ç³»å¯ä»¥è§ä¸‹å›¾ã€‚monoRepo ä¹Ÿè¢«ç§°ä½œ `multi-package repositories`ï¼Œæ³¨æ„å’Œ `multiRepo` åŒºåˆ†å¼€ ğŸ§ã€‚

![monoRepo](../images/monorepo.png)

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ monoRepo èƒ½ä¸ºæˆ‘ä»¬è§£å†³å“ªäº›ä¾¿åˆ©ï¼Œä»¥åŠæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦ monoRepoï¼Ÿ

## monoRepo çš„ä¼˜åŠ¿

### æ–¹ä¾¿ç®¡ç†

åœ¨æ–°äººå…¥èŒå…¬å¸ä¹‹åï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œç¬¬ä¸€å¤©åº”è¯¥éƒ½æ˜¯åœ¨å¼€é€šå„ç§ Git ä»“åº“çš„æƒé™ï¼ŒæŠŠé¡¹ç›®ä»£ç ä¸€ä¸ªä¸ª clone ä¸‹æ¥ï¼Œç„¶åéœ€è¦åœ¨æ¯ä¸ªé¡¹ç›®å®‰è£…ä¾èµ–ï¼Œæœ€åæ‰èƒ½å°†ä»£ç è·‘èµ·æ¥ã€‚

å¦‚æœé‡‡ç”¨ monoRepo çš„ç®¡ç†æ–¹å¼çš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å°†ä¼šå˜å¾—ç®€å•ä¸å°‘ã€‚å› ä¸ºä»£ç å…¨éƒ¨éƒ½é›†ä¸­åœ¨ä¸€ä¸ªä»“åº“ä¸­è¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ clone ä¸€ä¸ª Git ä»“åº“ï¼Œå¾ˆä¾¿æ·çš„å°±å¯ä»¥å°†ä¾èµ–å®‰è£…å¥½ï¼Œå¹¶å¯åŠ¨ä»»æ„é¡¹ç›®ã€‚è™½ç„¶å®‰è£…ä¾èµ–è¿‡ç¨‹éœ€è¦çš„æ—¶é—´æ¯”å®‰è£…å•ä¸ªé¡¹ç›®ä¾èµ–è¦é•¿ï¼Œä½†ç”±äº monoRepo èƒ½å¤Ÿå°†é¡¹ç›®ä¸‹çš„ä¾èµ–æŒ‰ç…§ä¸€å®šçš„è§„åˆ™è¿›è¡Œæå‡ï¼Œæ‰€ä»¥ node_modules çš„ä½“ç§¯è‚¯å®šæ˜¯è¦å°äº multiRepo çš„ã€‚

### ä»£ç å¤ç”¨

èº«ä¸ºä¸€ä¸ªæœ‰æ“å®ˆçš„ç¨‹åºå‘˜ï¼Œå¤§å®¶è‚¯å®šéƒ½æœ‰åœ¨éµå¾ªç€ **DRY** (Donâ€™t Repeat Yourself) åŸåˆ™ï¼Œå³å°½é‡çš„å»å®ç°ä»£ç å¤ç”¨ã€‚åœ¨å•ä¸ªé¡¹ç›®ä¸­å®ç°ä»£ç å¤ç”¨éå¸¸çš„ç®€å•ï¼Œå¯ä»¥å°†éœ€è¦å¤ç”¨çš„ä»£ç å­˜æ”¾åœ¨å•ç‹¬çš„æ–‡ä»¶å¤¹ä¸­ï¼Œéœ€è¦æ—¶ä»è¿™é‡Œå–å³å¯ã€‚

å¦‚æœæ˜¯åœ¨ä¸åŒçš„é¡¹ç›®ä¹‹é—´éœ€è¦è¿›è¡Œä»£ç å¤ç”¨å‘¢ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿæœ‰åŠæ³•ï¼Œæ¯”å¦‚å°†å¤ç”¨é€»è¾‘æå–ä¸º npm åŒ…ï¼Œåœ¨éœ€è¦çš„é¡¹ç›®ä¸­å¼•å…¥è¿™ä¸ªåŒ…ä¹Ÿèƒ½å®ç°ä»£ç å¤ç”¨ã€‚

è¿™ä¸ªæ–¹å¼ä¹Ÿæœ‰ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚åœ¨ npm å¼€å‘æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨ `npm link` æˆ–è€… `yarn link`çš„æ–¹å¼æ¥å¼€å‘ã€‚å¦‚æœå¤šäººåä½œå¼€å‘å¤šä¸ª npm åŒ…ï¼Œè¿™ä¸ª link çš„è¿‡ç¨‹è¿˜æ˜¯æŒºç¹ççš„ï¼Œè€Œä¸” link å®‰è£…çš„æœ¬åœ°ä¾èµ–ä¸ä¼šåœ¨ `package.json` ä½“ç°å‡ºæ¥ï¼Œç­‰åŒ…å‘å¸ƒåˆ° npm æ—¶ï¼Œéœ€è¦å†å…¨éƒ¨å®‰è£…ä¸€éã€‚

åœ¨é¡¹ç›®ä¸Šçº¿ä¹‹åï¼Œå¦‚æœæœ‰éœ€æ±‚æˆ–è€… bug éœ€è¦å¯¹ npm åŒ…(ç§°ä½œ moduleA å§)ä¸­çš„ä»£ç è¿›è¡Œæ”¹åŠ¨ï¼Œä½ å¯èƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹å‡ æ­¥

1. moduleA åŸºäº master è¿å‡ºæ–°çš„åˆ†æ”¯ï¼Œè¿›è¡Œå¼€å‘
2. åœ¨é¡¹ç›®ä¸­ç”¨ link çš„æ–¹å¼å®‰è£… moduleA
3. moduleA å¼€å‘å®Œæˆå¹¶æœ¬åœ°è‡ªæµ‹å®Œæˆåï¼Œpush åˆ°æµ‹è¯•åˆ†æ”¯
4. é¡¹ç›®ä¹Ÿéœ€è¦åŸºäº master è¿å‡ºæ–°çš„åˆ†æ”¯ï¼Œæ›´æ”¹ moduleA çš„ç‰ˆæœ¬å·ï¼Œæˆ–è€…è¿›è¡Œè¿™ä¸ªéœ€æ±‚çš„å…¶ä»–ä»£ç å¼€å‘ï¼Œå‘å¸ƒåˆ°æµ‹è¯•åˆ†æ”¯
5. æµ‹è¯•ç¯å¢ƒæµ‹è¯•æ²¡é—®é¢˜åï¼Œå‘å¸ƒåˆ°æ­£å¼ç¯å¢ƒä¹‹å‰éœ€è¦å…ˆå‘å¸ƒ moduleA

è¿™ä¸€ç³»åˆ—æ“ä½œä¸‹æ¥è¿˜æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œå¯¹å…¬æœ‰ npm åŒ…çš„ç®¡ç†ä¹Ÿéœ€è¦ä¸€å®šçš„æˆæœ¬ã€‚ç„¶è€Œï¼Œå¦‚æœä½ é€‰ç”¨äº† monoRepoï¼Œä¸Šé¢çš„é—®é¢˜åº”è¯¥éƒ½å¯ä»¥è¾ƒå¥½çš„è§£å†³ã€‚

åœ¨ monoRepo ä¸­è¿›è¡Œä»£ç å¤ç”¨å°±è·Ÿåœ¨å•ä¸ªé¡¹ç›®ä¸­ä¸€æ ·çš„ç®€å•ï¼ŒåŒæ ·å°†å¤ç”¨ä»£ç æå–åœ¨å•ç‹¬çš„æ–‡ä»¶å¤¹ã€‚åœ¨è¿­ä»£å¼€å§‹æ—¶ï¼Œå¯ä»¥åŸºäºä¸€ä¸ª commit æäº¤æœ¬æ¬¡æ›´æ–°çš„å†…å®¹ï¼Œä¹Ÿä¾¿äºä»£ç  reviewã€‚

### å·¥ç¨‹åŒ–ç»Ÿä¸€

åœ¨ multi repo çš„é¡¹ç›®ä¸­ï¼Œç”±äºæ¯ä¸ªé¡¹ç›®éƒ½æ˜¯å‰²è£‚çš„ï¼Œæ‰€ä»¥æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦å•ç‹¬çš„ eslintã€prettier ä»¥åŠå…¶ä»–ä¸€äº›åŸºç¡€å»ºè®¾ï¼Œè¿™æ ·çš„å·¥ä½œéƒ½æ˜¯é‡å¤ä¸”ç®€å•çš„ï¼Œå¦‚æœè¦åœ¨æ¯ä¸ªé¡¹ç›®ä¸­éƒ½ä¿æŒè§„åˆ™ã€ä»£ç é£æ ¼çš„ç»Ÿä¸€ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨æ¯ä¸ªé¡¹ç›®ä¸­ CV è¿™éƒ¨åˆ†é€»è¾‘ï¼Œ(åˆæ³•ï¼Œä½†ä¸æå€¡.jpg)ã€‚

## monoRepo ç¼ºç‚¹

å½“ç„¶ï¼ŒmonoRepo ä¹Ÿå¹¶éé“¶å¼¹ï¼Œå®ƒä¹Ÿå¸¦äº†ä¸€äº›æ–°çš„é—®é¢˜

- å¦‚æœé¡¹ç›®å¤ªå¤§ï¼Œgit æ“ä½œã€å®‰è£…ä¾èµ–ç­‰ä¼šå˜å¾—å¾ˆæ…¢
- monoRepo å°†å¤šä¸ªé¡¹ç›®æ•´åˆåœ¨äº†ä¸€èµ·ï¼Œæ‰€æœ‰é¡¹ç›®éƒ½æ˜¯å¯¹å…¨ä½“å‘˜å·¥å¼€æ”¾çš„ï¼Œæ²¡æœ‰åŠæ³•ä½¿ç”¨ Git å¯¹é¡¹ç›®åšæ–‡ä»¶å¤¹çº§åˆ«çš„æƒé™æ§åˆ¶ã€‚ä»å¦ä¸€æ–¹é¢æ¥è¯´ï¼Œå› ä¸ºä»£ç éƒ½æ˜¯å¼€æ”¾çš„ï¼Œå‘˜å·¥å¯èƒ½å› æ­¤æ›´åŠ æ³¨é‡ä»£ç è´¨é‡ã€‚

## workspaces

workspaces(å·¥ä½œåŒº) ç”± yarn æå‡ºï¼Œç”¨äºç®€åŒ– monoRepo æ¨¡å¼ä¸‹æœ¬åœ°ä¾èµ–åŒ…çš„ç®¡ç†ã€‚åœ¨ workspaces æ¨å‡ºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ link ï¼Œå½“æœ¬åœ°ä¾èµ–å¤ªå¤šæ—¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç¨æ˜¾ç¹çäº†ã€‚åœ¨ npm7 ä¹‹åï¼Œnpm ä¹Ÿæä¾›äº†å¯¹ worKspaces çš„æ”¯æŒã€‚ä»¥ npm workspaces ä¸ºä¾‹ç®€å•è®²è®² workspaces çš„ä½¿ç”¨

### npm workspaces

å®šä¹‰ä¸€ä¸ª workspaces é€šå¸¸çš„åšæ³•æ˜¯åœ¨æ ¹ç›®å½• `package.json` ä¸­æ·»åŠ  `workspaces` å­—æ®µï¼Œå¹¶åŠ ä¸Š `private` é˜²æ­¢è¯¯å‘å¸ƒåˆ° npm ä¸Šï¼Œæ¯•ç«Ÿé¡¹ç›®æ–‡ä»¶å¤¹ä¸‹çš„å…¶ä»–é¡¹ç›®æ‰æ˜¯æˆ‘ä»¬çœŸæ­£çš„ npm åŒ…ï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬çš„ `package.json` åº”è¯¥å°±æ˜¯ä¸‹é¢è¿™æ ·

```json
{
  "name": "npm-spaces",
  "version": "1.0.0",
  "private": true,
  "workspaces": ["packages/*"]
}
```

æ­¤æ—¶æˆ‘ä»¬çš„ packages æ–‡ä»¶å¤¹å°±æ˜¯ä¸€ä¸ªå·¥ä½œåŒºï¼Œæˆ‘ä»¬åœ¨ packages æ–‡ä»¶å¤¹æ–°å»ºä¸¤ä¸ªæ–‡ä»¶å¤¹ package-aã€package-b å³ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹ä¸‹éƒ½å»ºä¸€ä¸ªç‹¬ç«‹ package.json æ–‡ä»¶ï¼Œnpm ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†å‘½ä»¤

```bash
npm init -w ./packages/package-c
```

è¯¥å‘½ä»¤ä¼šè‡ªåŠ¨ä¼šåœ¨ packages æ–‡ä»¶å¤¹ä¸‹åˆ›å»º package-c æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨ package-c æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆ package.jsonã€‚

å½“æˆ‘ä»¬éœ€è¦åœ¨å­é¡¹ç›®ä¸­å®‰è£…ä¾èµ–æ—¶ï¼Œå¯ä»¥ä½¿ç”¨

```bash
npm install lodash-es package-b -w package-a
```

ä¸Šé¢çš„å‘½ä»¤å¯ä»¥åœ¨ package-a é¡¹ç›®ä¸­å®‰è£… lodash-es å’Œ package-bï¼Œè¿™ä¸ª package-b ä»“åº“ä¸ä¼šå‰å¾€ npm æºä¸Šå»æŸ¥æ‰¾ï¼Œè€Œæ˜¯å…ˆå¯»æ‰¾å·¥ä½œåŒºå†…æ˜¯å¦å­˜åœ¨è¯¥é¡¹ç›®ï¼Œå­˜åœ¨å°±ç›´æ¥å®‰è£…å·¥ä½œåŒºå†…çš„é¡¹ç›®ã€‚

æ­¤æ—¶æˆ‘ä»¬çš„é¡¹ç›®åº”è¯¥æ˜¯ä¸‹é¢è¿™ä¸ªç»“æ„

```shell
â”œâ”€â”€ node_modules
â”‚    â”œâ”€â”€ lodash-es
â”‚    â”œâ”€â”€ package-a
â”‚    â”œâ”€â”€ package-b
â”‚    â””â”€â”€ package-c
â”‚
â”œâ”€â”€ packages
â”‚    â”œâ”€â”€ package-a
â”‚    â”‚   â””â”€â”€  package.json
â”‚    â”‚
â”‚    â”œâ”€â”€ package-b
â”‚    â”‚   â””â”€â”€  package.json
â”‚    â”‚
â”‚    â””â”€â”€ package-c
â”‚        â””â”€â”€ package.json
â””â”€â”€ package.json
```

æ­¤æ—¶å¯ä»¥å‘ç° node_modules æ–‡ä»¶å¤¹ä¸‹å­˜åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸‰ä¸ª package ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘ packages æ–‡ä»¶å¤¹ä¸‹å¯¹åº”çš„æ–‡ä»¶å¤¹ã€‚

### yarn workspaces

yarn workspaces è·Ÿ npm ç”¨æ³•ç›¸ä¼¼ï¼Œå‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº† packages æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹ä¸‹æœ‰ `package-a`ï¼Œ`package-b`ï¼Œ`package-c`ä¸‰ä¸ªå­æ–‡ä»¶å¤¹ï¼Œä¸”éƒ½æœ‰è‡ªå·±çš„ `package.json`

æˆ‘ä»¬ä½¿ç”¨ `yarn workspace` å‘½ä»¤æ¥å®‰è£…ä¾èµ–

```shell
yarn workspace package-a add react package-b -S
```

å³åœ¨ package-a é¡¹ç›®ä¸­ï¼Œå®‰è£… react å’Œ package-b åŒ…ï¼Œç‚¹å¼€ node_modules ä¸€çœ‹ï¼Œå¥½å®¶ä¼™ï¼Œpackage-b å®‰è£…çš„ç‰ˆæœ¬æ˜¯ 0.5ï¼Œæ ¹æœ¬ä¸æ˜¯æˆ‘ä»¬é¢„æƒ³ä¸­çš„æœ¬åœ° package-bã€‚

æ‰“å¼€ npm æœç´¢ package-bï¼Œå››å¹´å‰å°±æœ‰äººæŠŠ `package-b` åŒ…ä¸Šä¼ åˆ° npm äº†(è¿˜æœ‰ä¸€ä¸ª `package-c` ä¹Ÿæ˜¯ä»–ä¸Šä¼ çš„ ğŸ˜‘)ã€‚æ¸©é¦¨æç¤ºï¼Œå®è·µçš„æ—¶å€™å¯ä»¥æ­å»ºç§æœ‰ npm æœåŠ¡ï¼Œå°† demo ä¸Šä¼ åˆ°å…¬æœ‰ä»“åº“æ˜¯ä¸å¤ªä¼˜é›…çš„ã€‚

![package-b](../images/package-b.png)

å¦‚æœéœ€è¦å®‰è£…æœ¬åœ°çš„åŒ…ï¼Œåˆ™éœ€è¦æŒ‡å®š version æ¥ç²¾ç¡®åŒ¹é…ï¼Œç„¶åæˆ‘æŠŠæœ¬åœ° package-b version æ”¹ä¸º 0.5.0ï¼ˆä¸ºäº†çœ‹åŒ¹é…çš„æ˜¯æœ¬åœ°è¿˜æ˜¯ npm æºï¼‰

```shell
yarn workspace package-a add package-b@0.5 -S
```

å—¯ï¼Œè¿™å›æ²¡æœ‰å» npm æºä¸‹è½½

ä½†æ˜¯è¿™æ ·è‚¯å®šä¸è¡Œï¼Œä¸ºäº†é¿å…å®‰è£…éå·¥ä½œåŒºåŒ…å¯èƒ½å¸¦æ¥çš„é£é™©ï¼Œ yarn V2 æ¨å‡ºäº† [workspace](https://yarnpkg.com/features/workspaces#workspace-ranges-workspace) åè®®ï¼Œä½¿ç”¨ workspace åè®®åï¼Œä¸å†èƒ½å¤Ÿå®‰è£…å·¥ä½œåŒºä¹‹å¤–çš„ä¾èµ–ï¼Œæ‰§è¡Œä¸‹é¢çš„å®‰è£…å‘½ä»¤

```shell
yarn workspace package-a add package-b -D
```

package-a ä¸‹çš„ `package.json`åº”è¯¥å¦‚ä¸‹ï¼Œé™¤éä½ æ‰‹åŠ¨æ›´æ”¹ package-b çš„ç‰ˆæœ¬å·ä¸ºé workspace çš„å®‰è£…æ–¹å¼ï¼Œå¦åˆ™ package-b å°†ä¸€ç›´é‡‡ç”¨å·¥ä½œåŒºä¸­çš„ç‰ˆæœ¬ã€‚

```json
{
  "name": "package-a",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "devDependencies": {
    "package-b": "workspace:^"
  }
}
```

å‡è®¾ä½ æŸä¸ªé¡¹ç›® PackA çš„ package.json å¦‚ä¸‹ï¼Œä¸”æ‰€æœ‰å·¥ä½œåŒºé¡¹ç›®çš„ç‰ˆæœ¬éƒ½ä¸º 1.5.0

```json
{
  "dependencies": {
    "star": "workspace:*",
    "caret": "workspace:^",
    "tilde": "workspace:~",
    "range": "workspace:^1.2.3",
    "path": "workspace:path/to/baz"
  }
}
```

åœ¨ä½ å‘å¸ƒ PackA æ—¶ï¼ŒPackA ä¸‹çš„ package.json å°†ä¼šæ ¹æ® semver è§„åˆ™è¿›è¡Œè½¬æ¢æˆå¦‚ä¸‹çš„å½¢å¼

```json
{
  "dependencies": {
    "star": "1.5.0",
    "caret": "^1.5.0",
    "tilde": "~1.5.0",
    "range": "^1.2.3",
    "path": "1.5.0"
  }
}
```

## lerna

å¦‚æœä½ äº†è§£è¿‡ monoRepoï¼Œé‚£ä¹ˆä½ åº”è¯¥ä¹Ÿå¬è¿‡ lernaï¼Œç”¨ [lerna](https://lerna.js.org/) å®˜ç½‘ä¸­çš„è¯æ¥æ¦‚æ‹¬ lerna

> Lerna is a tool that optimizes the workflow around managing multi-package repositories with git and npm.

lerna çš„æ ¸å¿ƒæŒ‡ä»¤æ˜¯ `lerna bootstrap` å’Œ `lerna publish`ï¼Œå‰è€…å¤„ç†ä¾èµ–é—®é¢˜ï¼Œåè€…è§£å†³å‘å¸ƒé—®é¢˜ï¼Œè¿™é‡Œç®€å•çš„ä»‹ç»ä¸€ä¸‹ lerna çš„ä½¿ç”¨ã€‚

è®©æˆ‘ä»¬å…ˆç”¨ `lerna init` æ–°å»ºä¸€ä¸ª lerna é¡¹ç›®ï¼Œå¹¶åœ¨ packages æ–‡ä»¶å¤¹ä¸‹ä½¿ç”¨ `lerna create` åˆ›å»º `package-a`, `package-b` å’Œ `package-c` ä¸‰ä¸ªå­é¡¹ç›®ï¼Œåœ¨ä¸‰ä¸ªé¡¹ç›®ä¸­éƒ½å®‰è£…ä¸Šä¾èµ–ã€‚

```shell
lerna add axios --scope package-a
```

è¿™æ—¶å€™æŸ¥çœ‹æˆ‘ä»¬çš„æ–‡ä»¶å¤¹ï¼Œåº”è¯¥æ˜¯ä¸‹é¢çš„ç»“æ„

```shell
â”œâ”€â”€ packages
â”‚    â”œâ”€â”€ package-a
â”‚    â”‚   â”œâ”€â”€  node_modules
â”‚    â”‚   â”‚    â””â”€â”€ axios
â”‚    â”‚   â””â”€â”€  package.json
â”‚    â”‚
â”‚    â”œâ”€â”€ package-b
â”‚    â”‚   â”œâ”€â”€  node_modules
â”‚    â”‚   â”‚    â””â”€â”€  axios
â”‚    â”‚   â””â”€â”€  package.json
â”‚    â”‚
â”‚    â””â”€â”€ package-b
â”‚    â”‚   â”œâ”€â”€  node_modules
â”‚    â”‚   â”‚    â””â”€â”€  axios
â”‚        â””â”€â”€ package.json
â”œâ”€â”€ lerna.json
â””â”€â”€ package.json
```

å¯ä»¥çœ‹åˆ° lerna åœ¨ä¸‰ä¸ªé¡¹ç›®ä¸­éƒ½å®‰è£…äº† axiosï¼Œæ˜¾ç„¶æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚lerna ä¹Ÿæä¾›äº†æ–¹æ³•å»å¤„ç†ä¾èµ–é—®é¢˜ã€‚

å…ˆç”¨ `lerna clean` å»æ¸…é™¤æ‰æ‰€æœ‰ package ä¸‹çš„ node_modulesï¼Œç„¶åç”¨ `lerna bootstrap --hoist` å°†æ‰€æœ‰ä¾èµ–éƒ½æå‡è‡³æ ¹ç›®å½•ã€‚

é€šè¿‡ä¸Šé¢ yarn workspace æˆ‘ä»¬çŸ¥é“ yarn ä¹Ÿæ˜¯æœ‰ä¾èµ–æå‡èƒ½åŠ›ï¼Œä¸”æ‹¥æœ‰æ¯” lerna æ›´å¥½çš„ä¾èµ–åˆ†æå’Œæå‡èƒ½åŠ›ï¼Œè€Œä¸” yarn æä¾›çš„å®‰è£…æ›´å‹å¥½ï¼Œä¸ç”¨å…ˆå®‰è£…åˆ° package é¡¹ç›® ä¸‹ï¼Œå†æ‰§è¡Œ `learn bootstrap --hoist` åˆ°æ ¹ç›®å½•ä¸‹ï¼Œå®ç°æ— æ„ŸçŸ¥çš„ä¾èµ–æå‡ï¼Œlerna è‡ªèº«ä¹Ÿæ¨èä½¿ç”¨ `yarn workspace` æ¥è¿›è¡Œä¾èµ–ç®¡ç†ã€‚

æ‰€ä»¥ä¸€ä¸ªè¾ƒå¥½çš„å®è·µæ˜¯ä½¿ç”¨ `yarn workspaces` çš„æ–¹å¼æ¥ç®¡ç† lerna ä¸‹çš„ä¾èµ–å…³ç³»ï¼Œåœ¨ `lerna.json` ä¸­æ·»åŠ ä¸Šä¸‹é¢å­—æ®µä¸”åœ¨ package.json ä¸­æ·»åŠ  workspaces å­—æ®µå³å¯ä½¿ç”¨ yarn ç®¡ç†ä¾èµ–

```json
{
  "npmClient": "yarn",
  "useWorkspaces": true
}
```

ä¸Šé¢æœ‰æåˆ° lerna çš„ä¸¤æ¡æ ¸å¿ƒæŒ‡ä»¤æ˜¯ bootstrap å’Œ publishï¼Œbootstrap æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ yarn workspace æ¥æå‡ä¾èµ–ï¼Œä¸”æ¯” lerna åšçš„æ›´å¥½ã€‚publish å¯å°±åªæœ‰æ˜¯ lerna æ“…é•¿çš„åœ°æ–¹äº†ã€‚

æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œ `lerna publish` æ—¶åšäº†å“ªäº›äº‹

1. æ‰¾å‡ºä¸Šä¸€ä¸ªç‰ˆæœ¬å‘å¸ƒä»¥æ¥æœ‰å˜æ›´çš„ package
2. æç¤ºå¼€å‘è€…ç¡®å®šç‰ˆæœ¬å·
3. æ›´æ–°éœ€è¦æ›´æ–°çš„ packages çš„ version å­—æ®µ
4. åˆ›å»ºæ–°çš„ commit æäº¤åˆ° git
5. å‘å¸ƒåˆ° npm

ä¹Ÿæœ‰ä¸€äº› lerna é€‚ç”¨çš„ç”Ÿæˆ changelog åŒ…ï¼Œæ¯”å¦‚ [lerna-changelog](https://www.npmjs.com/package/lerna-changelog) ã€[cz-lerna-changelog](https://www.npmjs.com/package/cz-lerna-changelog)ç­‰ç­‰ã€‚

## pnpm

å°½ç®¡ lerna + yarn workspace èƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³ monoRepo å¼€å‘ä¸­çš„é—®é¢˜ï¼Œç›®å‰çš„ monoRepo é¡¹ç›®ä¹Ÿå¤§éƒ½æ˜¯åŸºäº lerna + work workspace ï¼Œç”šè‡³ä¸€åº¦è¢«å¼€å‘è€…è®¤ä½œ monoRepo å¼€å‘çš„æœ€ä½³å®è·µã€‚ä½†æ˜¯ learn åœ¨æŒºä¹…ä»¥å‰å°±å·²ç»å¤„äºä¸€ä¸ª[æ— äººç»´æŠ¤](https://github.com/lerna/lerna/issues/2703)çš„çŠ¶æ€ã€‚

äºæˆ‘è€Œè¨€ï¼Œæˆ‘æ˜¯ä¸å¤§æƒ³å»ç”¨æ— äººç»´æŠ¤çš„å·¥å…·çš„ï¼Œäºæ˜¯æˆ‘åˆæ‰¾åˆ°äº† pnpmã€‚

pnpm ç›¸æ¯”äº npm æˆ–è€… yarnï¼Œå®ƒçš„ç”¨æˆ·é‡å’ŒçŸ¥ååº¦éƒ½ä¸æ˜¯å¾ˆé«˜ï¼Œä½†å®ƒä¹Ÿå‡­å€Ÿç€ä¸€äº›ä¼˜åŠ¿ï¼Œæ¯”å¦‚å¿«é€Ÿã€èŠ‚çœç©ºé—´çš„ä¾èµ–å®‰è£…ã€ä¸¥æ ¼çš„ä¾èµ–ç®¡ç†ï¼Œä»¥åŠä¼˜ç§€çš„ monoRepo æ”¯æŒï¼Œå¾—åˆ°äº†ä¸€éƒ¨åˆ†äººçš„å–œçˆ±ã€‚

å‰æ®µæ—¶é—´ï¼Œvue å®Œæˆäº†ä» `yarn workspaces` åˆ° `pnpm workspaces` çš„[è¿ç§»](https://github.com/vuejs/core/commit/61c5fbd3e35152f5f32e95bf04d3ee083414cecb)ï¼Œå¯èƒ½åœ¨ä¸ä¹…ä¹‹åï¼Œvue ç”Ÿæ€çš„éƒ½ä¼šå®Œæˆå‘ pnpm çš„è¿ç§»ã€‚

è¿™ç¯‡ä¸»è¦ä» workspace çš„è§’åº¦æ¥çœ‹ pnpm ä¸ºæˆ‘ä»¬å¸¦æ¥çš„ä¾¿åˆ©ã€‚å…³äºä» lerna åˆ° pnpm çš„è¿ç§»å¯ä»¥å‚è€ƒè¿™ç¯‡[Replacing Lerna + Yarn with PNPM Workspaces](https://www.raulmelo.dev/blog/replacing-lerna-and-yarn-with-pnpm-workspaces)

ä½ éœ€è¦æ–°å¢ä¸€ä¸ª `pnpm-workspace.yaml` æ–‡ä»¶ï¼Œ

```yaml
prefer-workspace-packages: true
packages:
  - "packages/*"
```

packages å­—æ®µè·Ÿ package.json ä¸­çš„ workspaces å­—æ®µä½œç”¨ä¸€è‡´ã€‚

å¦‚æœéœ€è¦åœ¨ç‰¹å®šçš„ package ä¸‹å®‰è£…ä¾èµ–ï¼Œå¯ä»¥æ‰§è¡Œ

```shell
pnpm add package-a axios --filter package-b
```

ä¸Šé¢çš„å‘½ä»¤å³åœ¨ package-b ä¸­å®‰è£… package-a å’Œ axiosï¼Œä¸Šé¢çš„ --filter ç±»ä¼¼ lerna çš„ --scopeï¼Œå…³äºä¸¤è€…çš„æ¯”è¾ƒå¯ä»¥æŸ¥çœ‹[pnpm vs Lerna: filtering in a multi-package repository](https://medium.com/pnpm/pnpm-vs-lerna-filtering-in-a-multi-package-repository-1f68bc644d6a)

æ­¤æ—¶ package-a ä¸­çš„ package.json åº”è¯¥æ˜¯ä¸‹é¢çš„æ ·å­ã€‚

```json
{
  "name": "package-a",
  "version": "1.0.0",
  "dependencies": {
    "axios": "^0.24.0",
    "package-b": "workspace:^1.0.0"
  }
}
```

å¯ä»¥çœ‹åˆ° pnpm ä¹Ÿæ”¯æŒäº† workspace åè®®ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å»ºä¸€ä¸ª demo æ¥ç®€å•èµ°ä¸€ä¸‹ pnpm workspaces ä»å¼€å‘åˆ°å‘å¸ƒçš„è¿‡ç¨‹ã€‚æˆ‘ä»¬åœ¨ packages æ–‡ä»¶å¤¹è§ä¸‰ä¸ªé¡¹ç›® package-aã€package-bã€package-cï¼Œå°±ç®€ç§° PAã€PBã€PC å§ã€‚å…¶ä¸­å‰ä¸¤ä¸ªä½œä¸ºå·¥å…·åº“ï¼ŒPC ä½œä¸ºä¸šåŠ¡é¡¹ç›®ã€‚

æˆ‘ä»¬åœ¨ PB ä¸­ï¼Œå®‰è£… `lodash-es`åŒ…ï¼Œ

```shell
pnpm add lodash-es --filter package-b
```

å¹¶åœ¨å…¥å£æ–‡ä»¶ä¸­æš´éœ²å‡ºä¸€ä¸ªå‡½æ•°

```js
// package-b
import { random } from "lodash-es";

export function randomNum(min, max) {
  return random(min, max);
}
```

é¡ºå¸¦ä¸€æï¼Œåœ¨ pnpm ä¸­çš„ npm åŒ…ä¸­ï¼Œè¿˜å¯ä»¥å®šä¹‰ publishConfig æ¥è¦†ç›–å‘å¸ƒä¹‹åçš„ package.json æ–‡ä»¶ï¼Œä¸¾ä¸ªæ —å­

```json
{
  "name": "foo",
  "version": "1.0.0",
  "main": "src/index.ts",
  "publishConfig": {
    "main": "dist/index.js",
    "typings": "dist/index.d.ts"
  }
}
```

å‘å¸ƒåˆ° npm ä¸Šæ—¶ï¼Œmain å­—æ®µå°†è¢«è¦†å†™ä¸º `dist/index.js`ï¼Œå°±å¯ä»¥å®ç°å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¸åŒçš„å…¥å£ã€‚

åœ¨ PA ä¸­ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•å†åšä¸€äº›äº‹

```shell
pnpm add package-b --filter package-a
```

```js
// package-a
import { randomNum } from "package-b";

export function deleteRandomItem(arr) {
  const length = arr.length;
  const index = randomNum(0, length - 1);
  arr.splice(index, 1);
}
```

åœ¨ PC ä¸­æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•äº†ï¼Œ

```shell
pnpm add package-a --filter package-c
```

```js
import { deleteRandomItem } from "package-a";

let arr = [1, 2, 3, 4, 5];
deleteRandomItem(arr);
```

å½“ç„¶åœ¨è¿™ä¸ª demo ä¸­è¿™æ ·çš„å°è£…æœ‰äº›å¤šæ­¤ä¸€ä¸¾ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥ä»‹ç» pnpm workspaces çš„ä½¿ç”¨ã€‚

æˆ‘ä»¬çš„åŒ…éƒ½å†™å¥½ä¹‹åï¼Œå°±éœ€è¦è€ƒè™‘å°†åŒ…æäº¤å‘å¸ƒç­‰æ“ä½œäº†ã€‚pnpm æ”¯æŒä½¿ç”¨ [changesets](https://github.com/changesets/changesets) æ¥ç®¡ç†ç‰ˆæœ¬ä»¥åŠç”Ÿæˆ changelogã€‚

åœ¨æ ¹ç›®å½•ä¸‹ï¼Œå®‰è£…ä¾èµ–ï¼Œå¹¶æ‰§è¡Œåˆå§‹åŒ–ã€‚

```shell
pnpm add -DW @changesets/cli

pnpm changeset init
```

ä¼šåœ¨ä½ çš„æ ¹ç›®å½•ä¸‹ç”Ÿæˆ `.changeset`æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹ä¸‹æœ‰ `config.json` å’Œ `README.md` ä¸¤ä¸ªæ–‡ä»¶ï¼Œå…³äº config çš„é…ç½®å¯ä»¥æŸ¥çœ‹[è¿™é‡Œ](https://github.com/changesets/changesets/blob/main/docs/config-file-options.md)

æ›´æ”¹ä¹‹åéœ€è¦å‘å¸ƒåˆ° npm ä¹‹å‰ï¼Œéœ€è¦ `pnpm changeset` æ ¹æ®å‘½ä»¤è¡Œæç¤ºæ¥å‘Šè¯‰ changeset æ­¤æ¬¡æäº¤æ¶‰åŠçš„èŒƒå›´ã€å¦‚ä½•æ›´æ”¹ç‰ˆæœ¬å·ï¼Œä»¥åŠæ›´æ”¹çš„å†…å®¹ã€‚

ä¹‹å changeset ä¼šåœ¨ .changeset ç”Ÿæˆä¸€ä¸ª md æ–‡ä»¶ï¼ˆæ–‡ä»¶åå¥½åƒæ²¡æœ‰å®é™…æ„ä¹‰ï¼‰ã€‚

```md
---
"package-a": minor
---

æ–°å¢ console
```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥å»æ›´æ”¹è¿™äº›ä¿¡æ¯ã€‚æ­¤æ—¶ changeset å·²ç»çŸ¥é“äº†åœ¨å“ªä¸ªé¡¹ç›®é‡Œæ€ä¹ˆå»æ›´æ”¹ç‰ˆæœ¬å·ï¼Œä»¥åŠç‰ˆæœ¬ä¿¡æ¯æ˜¯å•¥äº†ï¼Œä¸Šé¢çš„ md ç›¸å½“äºåœ¨ package-a é¡¹ç›®ä¸­æ‰§è¡Œ

```shell
npm version minor -m "æ–°å¢ console"
```

æ‰§è¡Œ `pnpm changeset version`å¯ä»¥ä¾ç…§ md æ–‡ä»¶æ›´æ–°ç‰ˆæœ¬å’Œ changelog

æ‰§è¡Œ `pnpm install`é‡æ–°ç”Ÿæˆ lock æ–‡ä»¶ã€‚

æœ€åæäº¤åˆ° gitï¼Œä»¥åŠ publish åˆ° npmã€‚

æµ‹è¯•çš„ demo ä¸å»ºè®®æ¨é€åˆ° npmï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [verdaccio](https://www.npmjs.com/package/verdaccio) æ­å»ºä¸€ä¸ªæœ¬åœ°çš„ npm æœåŠ¡ï¼Œæ¯”è¾ƒç®€å•è¿™é‡Œå°±ä¸æäº†ã€‚

## åè¯

å…³äº monoRepo æˆ‘ä¹Ÿå¹¶æ²¡æœ‰å¤ªå¤šçš„å®æˆ˜ç»éªŒï¼Œè¿™ç¯‡å…¶å®ç®—æ˜¯æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å­¦ä¹ æ€»ç»“ï¼Œå¯èƒ½åªç®—çº¸ä¸Šè°ˆå…µã€‚å¦‚æœåœ¨é˜…è¯»æœ¬ç¯‡æ—¶å‘ç°æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ¬¢è¿ä¸æˆ‘è”ç³»æ¢è®¨äº¤æµã€‚
